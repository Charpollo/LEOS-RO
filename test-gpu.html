<!DOCTYPE html>
<html>
<head>
    <title>RED ORBIT GPU Physics Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }
        #canvas {
            width: 100%;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        .test-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border: 2px solid #ff0000;
            border-radius: 5px;
        }
        .test-buttons button {
            display: block;
            width: 200px;
            margin: 5px 0;
            padding: 10px;
            background: #ff0000;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .test-buttons button:hover {
            background: #ff6600;
            transform: scale(1.05);
        }
        .test-buttons h3 {
            color: #ff0000;
            margin: 0 0 10px 0;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="info">
        <h2>GPU Physics Test</h2>
        <div>Status: <span id="status">Initializing...</span></div>
        <div>Engine: <span id="engine">-</span></div>
        <div>Objects: <span id="objects">0</span></div>
        <div>FPS: <span id="fps">0</span></div>
        <div>WebGPU: <span id="webgpu">Checking...</span></div>
    </div>
    
    <div class="test-buttons">
        <h3>Quick Tests</h3>
        <button onclick="testScale(10000)">10K Objects (Havok)</button>
        <button onclick="testScale(50000)">50K Objects (GPU)</button>
        <button onclick="testScale(100000)">100K Objects (GPU)</button>
        <button onclick="testScale(400000)">400K MEGA (GPU)</button>
        <button onclick="testScale(1000000)">1M MAXIMUM (GPU)</button>
        <button onclick="testKessler()" style="background: #ff00ff;">Trigger Kessler!</button>
        <button onclick="window.gpuControls?.toggle()" style="background: #00ff00;">Toggle Controls (G)</button>
    </div>
    
    <script type="module">
        import * as BABYLON from '@babylonjs/core';
        import { createPhysicsEngine } from './js/red-orbit/physics/physics-launcher.js';
        
        let engine, scene, camera;
        let physics;
        
        async function init() {
            // Get canvas
            const canvas = document.getElementById('canvas');
            
            // Create Babylon engine
            engine = new BABYLON.Engine(canvas, true, {
                preserveDrawingBuffer: true,
                stencil: true
            });
            
            // Create scene
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0, 0, 0);
            
            // Create camera
            camera = new BABYLON.ArcRotateCamera('camera', 
                -Math.PI/2, Math.PI/2, 50, 
                BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 100;
            
            // Add light
            const light = new BABYLON.HemisphericLight('light', 
                new BABYLON.Vector3(1, 1, 0), scene);
            
            // Create Earth
            const earth = BABYLON.MeshBuilder.CreateSphere('earth', {
                diameter: 2,
                segments: 32
            }, scene);
            const earthMat = new BABYLON.StandardMaterial('earthMat', scene);
            earthMat.diffuseColor = new BABYLON.Color3(0, 0, 0.5);
            earthMat.emissiveColor = new BABYLON.Color3(0, 0, 0.2);
            earth.material = earthMat;
            
            // Initialize physics with URL params
            const urlParams = new URLSearchParams(window.location.search);
            const initialCount = parseInt(urlParams.get('objects')) || 15000;
            
            physics = await createPhysicsEngine(scene, true);
            
            // Start render loop
            let lastTime = performance.now();
            engine.runRenderLoop(() => {
                const now = performance.now();
                const deltaTime = (now - lastTime) / 1000;
                lastTime = now;
                
                // Update physics
                if (physics) {
                    physics.step(deltaTime);
                }
                
                scene.render();
                
                // Update stats
                updateStats();
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                engine.resize();
            });
            
            // Update status
            document.getElementById('status').textContent = 'Ready!';
            document.getElementById('status').style.color = '#0f0';
            
            // Check WebGPU
            if (navigator.gpu) {
                document.getElementById('webgpu').textContent = 'Available ✓';
                document.getElementById('webgpu').style.color = '#0f0';
            } else {
                document.getElementById('webgpu').textContent = 'Not Available ✗';
                document.getElementById('webgpu').style.color = '#f00';
            }
        }
        
        function updateStats() {
            if (!physics) return;
            
            const stats = physics.getStats();
            document.getElementById('engine').textContent = stats.engineType || '-';
            document.getElementById('objects').textContent = stats.totalObjects || 0;
            document.getElementById('fps').textContent = engine.getFps().toFixed(0);
        }
        
        // Global test functions
        window.testScale = async function(count) {
            if (physics) {
                document.getElementById('status').textContent = `Scaling to ${count}...`;
                await physics.scaleToTarget(count);
                document.getElementById('status').textContent = `Running ${count} objects!`;
            }
        };
        
        window.testKessler = function() {
            if (physics) {
                physics.triggerKesslerSyndrome();
                document.getElementById('status').textContent = 'Kessler Triggered!';
                document.getElementById('status').style.color = '#ff00ff';
            }
        };
        
        // Initialize
        init().catch(console.error);
    </script>
</body>
</html>